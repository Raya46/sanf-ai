(()=>{var e={};e.id=276,e.ids=[276],e.modules={659:()=>{},3295:e=>{"use strict";e.exports=require("next/dist/server/app-render/after-task-async-storage.external.js")},10846:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},11997:e=>{"use strict";e.exports=require("punycode")},27910:e=>{"use strict";e.exports=require("stream")},28402:e=>{"use strict";e.exports=import("@opennextjs/cloudflare")},29294:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-async-storage.external.js")},34631:e=>{"use strict";e.exports=require("tls")},39542:(e,t,s)=>{"use strict";s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{OPTIONS:()=>d,POST:()=>l});var n=s(81248),o=s(5892),a=s(32190),i=s(28402),c=s(76033),u=e([i]);async function l(e){let t=await (0,c.U)(),s=new o.Xn;try{let{messages:r,applicationId:c}=await e.json();if(!c)return new Response("Missing applicationId",{status:400});let{data:{user:u}}=await t.auth.getUser();if(!u)return new Response("Unauthorized",{status:401});let{data:l,error:d}=await t.from("chat_sessions").select("id").eq("application_id",c).eq("user_id",u.id).single();if(d||!l)return console.error("Chat session not found:",d),new Response("Chat session not found",{status:404});let p=l.id,h=r[r.length-1];if("user"!==h.role)return new Response("Last message must be from user",{status:400});await t.from("chat_messages").insert({session_id:p,sender_type:"user",message_content:h.content});let{data:f,error:g}=await t.from("chat_messages").select("sender_type, message_content").eq("session_id",p).order("sent_at",{ascending:!0});if(g)return console.error("Error fetching chat history:",g),new Response("Error fetching history",{status:500});let m=f.map(e=>({role:"user"===e.sender_type?"user":"assistant",content:e.message_content})),A=h.content,y=function(){let e=process.env.OPENAI_API_KEY,t=null;console.log("Environment detection:",{nodeEnv:"production",isDevelopment:!1,isProduction:!0,hasCloudflareWorkers:"true"===process.env.CLOUDFLARE_WORKERS});try{let{env:s}=(0,i.getCloudflareContext)();t=s.AI,e=s.OPENAI_API_KEY,console.log("Production Cloudflare context accessed."),t&&console.log("AI binding successfully accessed via OpenNext context in production")}catch(e){console.error("Failed to access Cloudflare context in production:",{error:e instanceof Error?e.message:e,stack:e instanceof Error?e.stack:void 0}),globalThis.AI&&(t=globalThis.AI,console.log("AI binding accessed via globalThis fallback"))}if(console.log(`API Key loaded: ${e?`sk-...${e.slice(-4)}`:"Not found"}`),!e||0===e.length)throw Error("OPENAI_API_KEY not found or is empty in environment");return t?console.log("✅ AI binding successfully found and ready for AutoRAG"):(console.error("❌ Production: Cloudflare AI binding not available"),console.error("This indicates an issue with:"),console.error("1. Verify AI binding is configured in wrangler.jsonc"),console.error("2. Ensure deployed to Cloudflare Workers with proper bindings"),console.error("3. Verify AutoRAG is in the same Cloudflare account as the Worker")),{AI:t,OPENAI_API_KEY:e}}(),x=(0,n.r)({baseURL:"https://openrouter.ai/api/v1",apiKey:y.OPENAI_API_KEY}),I="";if(y.AI)try{s.append({status:"Searching documents..."});let e=process.env.AUTORAG_NAME||"sanf-credit-analysis-v2",t=await y.AI.autorag(e).search({query:A,max_num_results:5});t.data&&t.data.length>0?(I=t.data.map(e=>{let t=e.content.map(e=>e.text).join("\n\n");return`<file name="${e.filename}">${t}</file>`}).join("\n\n"),s.append({status:`Found ${t.data.length} documents.`})):s.append({status:"No relevant documents found."})}catch(e){console.error("AutoRAG operation failed:",e),s.append({status:"Document search failed."})}let w=[{role:"system",content:"You are SANF AI, a credit analysis assistant for Indonesian financial institutions. Always respond in Indonesian. When using provided documents, include 'Sumber: [filename1, filename2]' at the end of your response."},...m];I&&w.push({role:"user",content:`Here is some context from relevant documents:
${I}`}),w.push(h),s.append({status:"Generating response..."});let _=(await (0,o.gM)({model:x("gpt-4o-mini"),messages:w,async onFinish(e){await t.from("chat_messages").insert({session_id:p,sender_type:"ai",message_content:e.text}),s.append({status:"completed"}),s.close()}})).toDataStream();return s.close(),new a.NextResponse(_,{headers:{"Content-Type":"text/plain; charset=utf-8"}})}catch(t){console.error("Error in chat route:",t);let e=t instanceof Error?t.message:"An unknown error occurred";return new Response(e,{status:500})}}async function d(){return new Response(null,{status:204,headers:{"Access-Control-Allow-Origin":"*","Access-Control-Allow-Methods":"POST, OPTIONS","Access-Control-Allow-Headers":"Content-Type, Authorization"}})}i=(u.then?(await u)():u)[0],r()}catch(e){r(e)}})},44870:e=>{"use strict";e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},51906:e=>{function t(e){var t=Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}t.keys=()=>[],t.resolve=t,t.id=51906,e.exports=t},55511:e=>{"use strict";e.exports=require("crypto")},55591:e=>{"use strict";e.exports=require("https")},63033:e=>{"use strict";e.exports=require("next/dist/server/app-render/work-unit-async-storage.external.js")},74075:e=>{"use strict";e.exports=require("zlib")},74866:(e,t,s)=>{"use strict";s.a(e,async(e,r)=>{try{s.r(t),s.d(t,{patchFetch:()=>u,routeModule:()=>l,serverHooks:()=>h,workAsyncStorage:()=>d,workUnitAsyncStorage:()=>p});var n=s(96559),o=s(48088),a=s(37719),i=s(39542),c=e([i]);i=(c.then?(await c)():c)[0];let l=new n.AppRouteRouteModule({definition:{kind:o.RouteKind.APP_ROUTE,page:"/api/chat/route",pathname:"/api/chat",filename:"route",bundlePath:"app/api/chat/route"},resolvedPagePath:"C:\\Users\\raya\\project\\belajar_nextjs\\sanf-ai\\src\\app\\api\\chat\\route.ts",nextConfigOutput:"standalone",userland:i}),{workAsyncStorage:d,workUnitAsyncStorage:p,serverHooks:h}=l;function u(){return(0,a.patchFetch)({workAsyncStorage:d,workUnitAsyncStorage:p})}r()}catch(e){r(e)}})},76033:(e,t,s)=>{"use strict";s.d(t,{U:()=>o});var r=s(80261),n=s(44999);let o=async()=>{let e=await (0,n.UL)();return(0,r.createServerClient)("https://gskcziircorxypqexcuh.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imdza2N6aWlyY29yeHlwcWV4Y3VoIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA1OTUyMTMsImV4cCI6MjA2NjE3MTIxM30.gQg76c18soHVeuRqxjnPiIji088qp7NTVguZUsyePDM",{cookies:{getAll:()=>e.getAll(),setAll(t){try{t.forEach(({name:t,value:s,options:r})=>{e.set(t,s,r)})}catch{console.log("Cookie setting error in Server Component - can be ignored if using middleware")}}}})}},78335:()=>{},79428:e=>{"use strict";e.exports=require("buffer")},79551:e=>{"use strict";e.exports=require("url")},81630:e=>{"use strict";e.exports=require("http")},84882:()=>{},91645:e=>{"use strict";e.exports=require("net")},94735:e=>{"use strict";e.exports=require("events")},96487:()=>{}};var t=require("../../../webpack-runtime.js");t.C(e);var s=e=>t(t.s=e),r=t.X(0,[447,875,580,576,9],()=>s(74866));module.exports=r})();